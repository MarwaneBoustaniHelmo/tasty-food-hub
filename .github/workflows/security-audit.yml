name: Security Audit & Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly security audit every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual trigger

jobs:
  security-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true # Don't fail build on vulnerabilities

      - name: Generate audit report
        run: npm audit --json > audit-report.json || true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for secret scanning

      - name: Check for hardcoded API keys
        run: |
          echo "ðŸ” Scanning for potential API keys..."
          
          # Check for Gemini API keys
          if grep -r "AIzaSy" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" src/; then
            echo "âŒ ERROR: Potential Gemini API key found in source code!"
            exit 1
          fi
          
          # Check for Supabase service role keys (different from public anon key)
          if grep -r "eyJhbGc.*service_role" --include="*.ts" --include="*.tsx" src/; then
            echo "âŒ ERROR: Supabase service role key found in frontend!"
            exit 1
          fi
          
          # Check for hardcoded passwords
          if grep -ri "password\s*=\s*['\"]" --include="*.ts" --include="*.tsx" --include="*.js" src/ | grep -v "type password"; then
            echo "âŒ ERROR: Hardcoded password found!"
            exit 1
          fi
          
          # Check for FTP credentials
          if grep -ri "ftp.*password" --include="*.ts" --include="*.js" src/; then
            echo "âŒ ERROR: FTP credentials found in source!"
            exit 1
          fi
          
          echo "âœ… No hardcoded secrets detected in src/"

      - name: Check for secrets in package files
        run: |
          echo "ðŸ” Checking package.json for suspicious scripts..."
          
          if grep -i "postinstall.*curl\|wget" package.json; then
            echo "âš ï¸ WARNING: Suspicious postinstall script detected"
          fi
          
          echo "âœ… Package.json looks clean"

  build-test:
    name: Build & TypeScript Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: Build frontend
        run: npm run build
        env:
          # Use example values for CI build
          VITE_API_URL: "http://localhost:3001"
          VITE_SUPABASE_URL: "https://example.supabase.co"
          VITE_SUPABASE_PUBLISHABLE_KEY: "example-anon-key"

      - name: Remove sensitive files from build
        run: |
          echo "ðŸ§¹ Cleaning sensitive files from dist/..."
          # Remove any .env files that might have been copied
          find dist -type f -name ".env*" -delete 2>/dev/null || true
          # Remove any backup files
          find dist -type f -name "*~" -delete 2>/dev/null || true
          # Remove any .git directories
          find dist -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true
          echo "âœ… Cleanup complete"

      - name: Check build artifacts
        run: |
          echo "ðŸ“¦ Checking dist/ for sensitive files..."
          
          # Ensure no .env files in dist
          if find dist -name ".env*" -type f; then
            echo "âŒ ERROR: .env files found in build output!"
            exit 1
          fi
          
          # Ensure no source maps with API keys (optional check)
          if grep -r "AIzaSy" dist/ 2>/dev/null; then
            echo "âš ï¸ WARNING: API key found in build artifacts!"
          fi
          
          echo "âœ… Build artifacts look clean"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  lint:
    name: ESLint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true # Don't fail on lint errors

  security-headers-check:
    name: Verify Security Headers
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Check production security headers
        run: |
          echo "ðŸ”’ Checking security headers for https://tastyfood.me"
          
          response=$(curl -sI https://tastyfood.me || echo "CURL_FAILED")
          
          if [[ "$response" == "CURL_FAILED" ]]; then
            echo "âš ï¸ Cannot reach production site"
            exit 0
          fi
          
          # Check for key security headers
          if echo "$response" | grep -qi "X-Frame-Options"; then
            echo "âœ… X-Frame-Options header present"
          else
            echo "âš ï¸ WARNING: X-Frame-Options header missing"
          fi
          
          if echo "$response" | grep -qi "Strict-Transport-Security"; then
            echo "âœ… HSTS header present"
          else
            echo "âš ï¸ WARNING: HSTS header missing"
          fi
          
          if echo "$response" | grep -qi "X-Content-Type-Options"; then
            echo "âœ… X-Content-Type-Options header present"
          else
            echo "âš ï¸ WARNING: X-Content-Type-Options missing"
          fi

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-audit, secret-scan, build-test, lint]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ›¡ï¸ Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM Audit**: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Secret Scan**: ${{ needs.secret-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Test**: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint Check**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated: $(date)" >> $GITHUB_STEP_SUMMARY
